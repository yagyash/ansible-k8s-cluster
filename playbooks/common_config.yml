---
 - name: Pre-req for K8s deploy
   hosts: all
   become: yes
   tasks:
    - name: Add hostname to each node
      copy:
        dest: /etc/hosts
        content: |
          127.0.0.1 localhost 
          {% for host in groups['all'] %}
          {{ hostvars[host]['ansible_host'] }} {{ host }}
          {% endfor %}

    - name: Disable Swap
      command: swapoff -a
    
    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: "swap"
        state: absent

    - name: Add kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
    - name: Load kernel modueles
      shell: |
        modprobe overlay
        modprobe br_netfilter

    - name: Add Sysctl parameters
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Load Sysctl parameters
      shell: |
        sysctl --system

    - name: Install containerd
      apt:
        name: containerd
        state: present

    - name: Configure containerd
      shell: |
        mkdir -p /etc/containerd
        containerd config default | sudo tee /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

    - name: Enable and start containerd
      systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Install kubernetes package
      shell: |
        apt install -y kubelet kubeadm kubectl

    - name: Enable and start kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes






